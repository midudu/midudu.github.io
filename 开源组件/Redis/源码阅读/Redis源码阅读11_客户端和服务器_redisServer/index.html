
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Redis 源码阅读11_客户端和服务器_redisServer | Midudu&#39;s Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="redis 单机服务器  涉及文件 redis server 1. 设置各种东西 2. 初始化服务器 3. 如果服务器以 Sentinel 模式启动，那么进行 Sentinel 功能相关的初始化 4. 读命令行用户输入，进行配置 5. 将服务器设置为守护进程 6. 创建并初始化服务器数据结构 7. 如果服务器是守护进程，那么创建 PID 文件 8. 为服务器进程设置名字 9. 打印 ASCII L">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis 源码阅读11_客户端和服务器_redisServer">
<meta property="og:url" content="http://yoursite.com/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/Redis/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/Redis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB11_%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8_redisServer/index.html">
<meta property="og:site_name" content="Midudu&#39;s Home">
<meta property="og:description" content="redis 单机服务器  涉及文件 redis server 1. 设置各种东西 2. 初始化服务器 3. 如果服务器以 Sentinel 模式启动，那么进行 Sentinel 功能相关的初始化 4. 读命令行用户输入，进行配置 5. 将服务器设置为守护进程 6. 创建并初始化服务器数据结构 7. 如果服务器是守护进程，那么创建 PID 文件 8. 为服务器进程设置名字 9. 打印 ASCII L">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-03-11T12:25:46.351Z">
<meta property="article:modified_time" content="2020-03-11T12:28:36.000Z">
<meta property="article:author" content="Midudu">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="C">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="Midudu&#39;s Home" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 4.2.0"></head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Midudu&#39;s Home</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="yoursite.com">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main"><article id="post-Redis源码阅读11_客户端和服务器_redisServer" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/Redis/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/Redis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB11_%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8_redisServer/" class="article-date">
  <time datetime="2020-03-11T12:25:46.351Z" itemprop="datePublished">2020-03-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/">开源组件</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/Redis/">Redis</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/Redis/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">源码阅读</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Redis 源码阅读11_客户端和服务器_redisServer
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>redis 单机服务器</p>
<ul>
<li><a href="#%e6%b6%89%e5%8f%8a%e6%96%87%e4%bb%b6">涉及文件</a></li>
<li><a href="#redis-server">redis server</a><ul>
<li><a href="#1-%e8%ae%be%e7%bd%ae%e5%90%84%e7%a7%8d%e4%b8%9c%e8%a5%bf">1. 设置各种东西</a></li>
<li><a href="#2-%e5%88%9d%e5%a7%8b%e5%8c%96%e6%9c%8d%e5%8a%a1%e5%99%a8">2. 初始化服务器</a></li>
<li><a href="#3-%e5%a6%82%e6%9e%9c%e6%9c%8d%e5%8a%a1%e5%99%a8%e4%bb%a5-sentinel-%e6%a8%a1%e5%bc%8f%e5%90%af%e5%8a%a8%e9%82%a3%e4%b9%88%e8%bf%9b%e8%a1%8c-sentinel-%e5%8a%9f%e8%83%bd%e7%9b%b8%e5%85%b3%e7%9a%84%e5%88%9d%e5%a7%8b%e5%8c%96">3. 如果服务器以 Sentinel 模式启动，那么进行 Sentinel 功能相关的初始化</a></li>
<li><a href="#4-%e8%af%bb%e5%91%bd%e4%bb%a4%e8%a1%8c%e7%94%a8%e6%88%b7%e8%be%93%e5%85%a5%e8%bf%9b%e8%a1%8c%e9%85%8d%e7%bd%ae">4. 读命令行用户输入，进行配置</a></li>
<li><a href="#5-%e5%b0%86%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%ae%be%e7%bd%ae%e4%b8%ba%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8b">5. 将服务器设置为守护进程</a></li>
<li><a href="#6-%e5%88%9b%e5%bb%ba%e5%b9%b6%e5%88%9d%e5%a7%8b%e5%8c%96%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84">6. 创建并初始化服务器数据结构</a></li>
<li><a href="#7-%e5%a6%82%e6%9e%9c%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%98%af%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8b%e9%82%a3%e4%b9%88%e5%88%9b%e5%bb%ba-pid-%e6%96%87%e4%bb%b6">7. 如果服务器是守护进程，那么创建 PID 文件</a></li>
<li><a href="#8-%e4%b8%ba%e6%9c%8d%e5%8a%a1%e5%99%a8%e8%bf%9b%e7%a8%8b%e8%ae%be%e7%bd%ae%e5%90%8d%e5%ad%97">8. 为服务器进程设置名字</a></li>
<li><a href="#9-%e6%89%93%e5%8d%b0-ascii-logo">9. 打印 ASCII LOGO</a></li>
<li><a href="#10-%e8%bd%bd%e5%85%a5-rdb-%e5%92%8c-aof-%e6%96%87%e4%bb%b6">10. 载入 rdb 和 aof 文件</a></li>
<li><a href="#11-%e8%ae%be%e7%bd%ae-before-sleep-%e6%96%b9%e6%b3%95">11. 设置 before sleep 方法</a></li>
<li><a href="#12-%e5%bc%80%e5%a7%8b%e4%b8%bb-loop">12. 开始主 loop</a></li>
<li><a href="#13-%e7%bb%93%e6%9d%9f%e6%b8%85%e7%90%86-loop">13. 结束，清理 loop</a></li>
</ul>
</li>
<li><a href="#%e5%85%b3%e4%ba%8e%e5%87%a0%e4%b8%aa%e6%96%87%e4%bb%b6%e4%ba%8b%e4%bb%b6%e5%a4%84%e7%90%86%e5%99%a8%e7%9a%84%e9%80%bb%e8%be%91%e5%85%b3%e7%b3%bb">关于几个文件事件处理器的逻辑关系</a></li>
<li><a href="#redis-%e4%b8%8d%e8%83%bd%e7%ae%80%e5%8d%95%e8%af%b4%e6%98%af%e4%b8%80%e4%b8%aa%e5%8d%95%e8%bf%9b%e7%a8%8b%e5%8d%95%e7%ba%bf%e7%a8%8b-reactor">redis 不能简单说是一个单进程单线程 reactor</a></li>
</ul>
<h2 id="涉及文件"><a href="#涉及文件" class="headerlink" title="涉及文件"></a>涉及文件</h2><p><code>redis.c</code></p>
<h2 id="redis-server"><a href="#redis-server" class="headerlink" title="redis server"></a>redis server</h2><p>main 函数在 redis.c 中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We need to initialize our libraries, and the server configuration. */</span></span><br><span class="line">    <span class="comment">// 初始化库</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> INIT_SETPROCTITLE_REPLACEMENT</span></span><br><span class="line">    spt_init(argc, argv);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    setlocale(LC_COLLATE, <span class="string">""</span>);</span><br><span class="line">    zmalloc_enable_thread_safeness();</span><br><span class="line">    zmalloc_set_oom_handler(redisOutOfMemoryHandler);</span><br><span class="line">    srand(time(<span class="literal">NULL</span>) ^ getpid());</span><br><span class="line">    gettimeofday(&amp;tv, <span class="literal">NULL</span>);</span><br><span class="line">    dictSetHashFunctionSeed(tv.tv_sec ^ tv.tv_usec ^ getpid());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查服务器是否以 Sentinel 模式启动</span></span><br><span class="line">    server.sentinel_mode = checkForSentinelMode(argc, argv);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化服务器</span></span><br><span class="line">    initServerConfig();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We need to init sentinel right now as parsing the configuration file</span></span><br><span class="line"><span class="comment">     * in sentinel mode will have the effect of populating the sentinel</span></span><br><span class="line"><span class="comment">     * data structures with master nodes to monitor. */</span></span><br><span class="line">    <span class="comment">// 如果服务器以 Sentinel 模式启动，那么进行 Sentinel 功能相关的初始化</span></span><br><span class="line">    <span class="comment">// 并为要监视的主服务器创建一些相应的数据结构</span></span><br><span class="line">    <span class="keyword">if</span> (server.sentinel_mode) &#123;</span><br><span class="line">        initSentinelConfig();</span><br><span class="line">        initSentinel();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查用户是否指定了配置文件，或者配置选项</span></span><br><span class="line">    <span class="keyword">if</span> (argc &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">1</span>; <span class="comment">/* First option to parse in argv[] */</span></span><br><span class="line">        sds options = sdsempty();</span><br><span class="line">        <span class="keyword">char</span> *configfile = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Handle special options --help and --version */</span></span><br><span class="line">        <span class="comment">// 处理特殊选项 -h 、-v 和 --test-memory</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"-v"</span>) == <span class="number">0</span> ||</span><br><span class="line">            <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--version"</span>) == <span class="number">0</span>)</span><br><span class="line">            version();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--help"</span>) == <span class="number">0</span> ||</span><br><span class="line">            <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"-h"</span>) == <span class="number">0</span>)</span><br><span class="line">            usage();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--test-memory"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (argc == <span class="number">3</span>) &#123;</span><br><span class="line">                memtest(atoi(argv[<span class="number">2</span>]), <span class="number">50</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Please specify the amount of memory to test in megabytes.\n"</span>);</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Example: ./redis-server --test-memory 4096\n\n"</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* First argument is the config file name? */</span></span><br><span class="line">        <span class="comment">// 如果第一个参数（argv[1]）不是以 "--" 开头</span></span><br><span class="line">        <span class="comment">// 那么它应该是一个配置文件</span></span><br><span class="line">        <span class="keyword">if</span> (argv[j][<span class="number">0</span>] != <span class="string">'-'</span> || argv[j][<span class="number">1</span>] != <span class="string">'-'</span>)</span><br><span class="line">            configfile = argv[j++];</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* All the other options are parsed and conceptually appended to the</span></span><br><span class="line"><span class="comment">         * configuration file. For instance --port 6380 will generate the</span></span><br><span class="line"><span class="comment">         * string "port 6380\n" to be parsed after the actual file name</span></span><br><span class="line"><span class="comment">         * is parsed, if any. */</span></span><br><span class="line">        <span class="comment">// 对用户给定的其余选项进行分析，并将分析所得的字符串追加稍后载入的配置文件的内容之后</span></span><br><span class="line">        <span class="comment">// 比如 --port 6380 会被分析为 "port 6380\n"</span></span><br><span class="line">        <span class="keyword">while</span> (j != argc) &#123;</span><br><span class="line">            <span class="keyword">if</span> (argv[j][<span class="number">0</span>] == <span class="string">'-'</span> &amp;&amp; argv[j][<span class="number">1</span>] == <span class="string">'-'</span>) &#123;</span><br><span class="line">                <span class="comment">/* Option name */</span></span><br><span class="line">                <span class="keyword">if</span> (sdslen(options)) options = sdscat(options, <span class="string">"\n"</span>);</span><br><span class="line">                options = sdscat(options, argv[j] + <span class="number">2</span>);</span><br><span class="line">                options = sdscat(options, <span class="string">" "</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* Option argument */</span></span><br><span class="line">                options = sdscatrepr(options, argv[j], <span class="built_in">strlen</span>(argv[j]));</span><br><span class="line">                options = sdscat(options, <span class="string">" "</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (configfile) server.configfile = getAbsolutePath(configfile);</span><br><span class="line">        <span class="comment">// 重置保存条件</span></span><br><span class="line">        resetServerSaveParams();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 载入配置文件， options 是前面分析出的给定选项</span></span><br><span class="line">        loadServerConfig(configfile, options);</span><br><span class="line">        sdsfree(options);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取配置文件的绝对路径</span></span><br><span class="line">        <span class="keyword">if</span> (configfile) server.configfile = getAbsolutePath(configfile);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        redisLog(REDIS_WARNING,</span><br><span class="line">                 <span class="string">"Warning: no config file specified, using the default config. In order to specify a config file use %s /path/to/%s.conf"</span>,</span><br><span class="line">                 argv[<span class="number">0</span>], server.sentinel_mode ? <span class="string">"sentinel"</span> : <span class="string">"redis"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将服务器设置为守护进程</span></span><br><span class="line">    <span class="keyword">if</span> (server.daemonize) daemonize();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建并初始化服务器数据结构</span></span><br><span class="line">    initServer();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果服务器是守护进程，那么创建 PID 文件</span></span><br><span class="line">    <span class="keyword">if</span> (server.daemonize) createPidFile();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为服务器进程设置名字</span></span><br><span class="line">    redisSetProcTitle(argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印 ASCII LOGO</span></span><br><span class="line">    redisAsciiArt();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果服务器不是运行在 SENTINEL 模式，那么执行以下代码</span></span><br><span class="line">    <span class="keyword">if</span> (!server.sentinel_mode) &#123;</span><br><span class="line">        <span class="comment">/* Things not needed when running in Sentinel mode. */</span></span><br><span class="line">        <span class="comment">// 打印问候语</span></span><br><span class="line">        redisLog(REDIS_WARNING, <span class="string">"Server started, Redis version "</span> REDIS_VERSION);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __linux__</span></span><br><span class="line">        <span class="comment">// 打印内存警告</span></span><br><span class="line">        linuxOvercommitMemoryWarning();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 从 AOF 文件或者 RDB 文件中载入数据</span></span><br><span class="line">        loadDataFromDisk();</span><br><span class="line">        <span class="comment">// 启动集群？</span></span><br><span class="line">        <span class="keyword">if</span> (server.cluster_enabled) &#123;</span><br><span class="line">            <span class="keyword">if</span> (verifyClusterConfigWithData() == REDIS_ERR) &#123;</span><br><span class="line">                redisLog(REDIS_WARNING,</span><br><span class="line">                         <span class="string">"You can't have keys in a DB different than DB 0 when in "</span></span><br><span class="line">                         <span class="string">"Cluster mode. Exiting."</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 打印 TCP 端口</span></span><br><span class="line">        <span class="keyword">if</span> (server.ipfd_count &gt; <span class="number">0</span>)</span><br><span class="line">            redisLog(REDIS_NOTICE, <span class="string">"The server is now ready to accept connections on port %d"</span>, server.port);</span><br><span class="line">        <span class="comment">// 打印本地套接字端口</span></span><br><span class="line">        <span class="keyword">if</span> (server.sofd &gt; <span class="number">0</span>)</span><br><span class="line">            redisLog(REDIS_NOTICE, <span class="string">"The server is now ready to accept connections at %s"</span>, server.unixsocket);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sentinelIsRunning();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Warning the user about suspicious maxmemory setting. */</span></span><br><span class="line">    <span class="comment">// 检查不正常的 maxmemory 配置</span></span><br><span class="line">    <span class="keyword">if</span> (server.maxmemory &gt; <span class="number">0</span> &amp;&amp; server.maxmemory &lt; <span class="number">1024</span> * <span class="number">1024</span>) &#123;</span><br><span class="line">        redisLog(REDIS_WARNING,</span><br><span class="line">                 <span class="string">"WARNING: You specified a maxmemory value that is less than 1MB (current value is %llu bytes). Are you sure this is what you really want?"</span>,</span><br><span class="line">                 server.maxmemory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 运行事件处理器，一直到服务器关闭为止</span></span><br><span class="line">    aeSetBeforeSleepProc(server.el, beforeSleep);</span><br><span class="line">    aeMain(server.el);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务器关闭，停止事件循环</span></span><br><span class="line">    aeDeleteEventLoop(server.el);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-设置各种东西"><a href="#1-设置各种东西" class="headerlink" title="1. 设置各种东西"></a>1. 设置各种东西</h3><pre><code><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">setlocale(LC_COLLATE, <span class="string">""</span>);  <span class="comment">// locale</span></span><br><span class="line">zmalloc_enable_thread_safeness();  <span class="comment">// zmalloc thread safe</span></span><br><span class="line">zmalloc_set_oom_handler(redisOutOfMemoryHandler);  <span class="comment">// 这个 handler 只是 log，基本啥也不干</span></span><br><span class="line">srand(time(<span class="literal">NULL</span>) ^ getpid());  <span class="comment">// 生成时间随机数种子，用于 hash 的种子</span></span><br><span class="line">gettimeofday(&amp;tv, <span class="literal">NULL</span>);</span><br><span class="line">dictSetHashFunctionSeed(tv.tv_sec ^ tv.tv_usec ^ getpid());</span><br></pre></td></tr></table></figure></code></pre><h3 id="2-初始化服务器"><a href="#2-初始化服务器" class="headerlink" title="2. 初始化服务器"></a>2. 初始化服务器</h3><pre><code><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">initServerConfig();</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

initServerConfig 实在太长，还是直接看源码吧。

但是初始化 command 的部分有点意思，看一下：

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server.commands = dictCreate(&amp;commandTableDictType, <span class="literal">NULL</span>);</span><br><span class="line">server.orig_commands = dictCreate(&amp;commandTableDictType, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">populateCommandTable();</span><br><span class="line"></span><br><span class="line">server.delCommand = lookupCommandByCString(<span class="string">"del"</span>);</span><br><span class="line">server.multiCommand = lookupCommandByCString(<span class="string">"multi"</span>);</span><br><span class="line">server.lpushCommand = lookupCommandByCString(<span class="string">"lpush"</span>);</span><br><span class="line">server.lpopCommand = lookupCommandByCString(<span class="string">"lpop"</span>);</span><br><span class="line">server.rpopCommand = lookupCommandByCString(<span class="string">"rpop"</span>);</span><br></pre></td></tr></table></figure>

这里又分为 3 个部分：

- 首先创建两个字典 server.commands 和 server.orig_commands ，之所以要有两个的原因是，客户端可以通过 rename 操作把一些命令改个名字，所以要用 orig_commands 备份一份

- 然后初始化命令列表 populateCommandTable()

    <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisCommand</span> <span class="title">redisCommandTable</span>[] = &#123;</span></span><br><span class="line">&#123;<span class="string">"get"</span>,              getCommand,              <span class="number">2</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"set"</span>,              setCommand,              <span class="number">-3</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"setnx"</span>,            setnxCommand,            <span class="number">3</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"setex"</span>,            setexCommand,            <span class="number">4</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"psetex"</span>,           psetexCommand,           <span class="number">4</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"append"</span>,           appendCommand,           <span class="number">3</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"strlen"</span>,           strlenCommand,           <span class="number">2</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"del"</span>,              delCommand,              <span class="number">-2</span>, <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">-1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"exists"</span>,           existsCommand,           <span class="number">2</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"setbit"</span>,           setbitCommand,           <span class="number">4</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"getbit"</span>,           getbitCommand,           <span class="number">3</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"setrange"</span>,         setrangeCommand,         <span class="number">4</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"getrange"</span>,         getrangeCommand,         <span class="number">4</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"substr"</span>,           getrangeCommand,         <span class="number">4</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"incr"</span>,             incrCommand,             <span class="number">2</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"decr"</span>,             decrCommand,             <span class="number">2</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"mget"</span>,             mgetCommand,             <span class="number">-2</span>, <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">-1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"rpush"</span>,            rpushCommand,            <span class="number">-3</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"lpush"</span>,            lpushCommand,            <span class="number">-3</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"rpushx"</span>,           rpushxCommand,           <span class="number">3</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"lpushx"</span>,           lpushxCommand,           <span class="number">3</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"linsert"</span>,          linsertCommand,          <span class="number">5</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"rpop"</span>,             rpopCommand,             <span class="number">2</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"lpop"</span>,             lpopCommand,             <span class="number">2</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"brpop"</span>,            brpopCommand,            <span class="number">-3</span>, <span class="string">"ws"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"brpoplpush"</span>,       brpoplpushCommand,       <span class="number">4</span>,  <span class="string">"wms"</span>,   <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">2</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"blpop"</span>,            blpopCommand,            <span class="number">-3</span>, <span class="string">"ws"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">-2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"llen"</span>,             llenCommand,             <span class="number">2</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"lindex"</span>,           lindexCommand,           <span class="number">3</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"lset"</span>,             lsetCommand,             <span class="number">4</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"lrange"</span>,           lrangeCommand,           <span class="number">4</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"ltrim"</span>,            ltrimCommand,            <span class="number">4</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"lrem"</span>,             lremCommand,             <span class="number">4</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"rpoplpush"</span>,        rpoplpushCommand,        <span class="number">3</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">2</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"sadd"</span>,             saddCommand,             <span class="number">-3</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"srem"</span>,             sremCommand,             <span class="number">-3</span>, <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"smove"</span>,            smoveCommand,            <span class="number">4</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">2</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"sismember"</span>,        sismemberCommand,        <span class="number">3</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"scard"</span>,            scardCommand,            <span class="number">2</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"spop"</span>,             spopCommand,             <span class="number">2</span>,  <span class="string">"wRs"</span>,   <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"srandmember"</span>,      srandmemberCommand,      <span class="number">-2</span>, <span class="string">"rR"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"sinter"</span>,           sinterCommand,           <span class="number">-2</span>, <span class="string">"rS"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">-1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"sinterstore"</span>,      sinterstoreCommand,      <span class="number">-3</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">-1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"sunion"</span>,           sunionCommand,           <span class="number">-2</span>, <span class="string">"rS"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">-1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"sunionstore"</span>,      sunionstoreCommand,      <span class="number">-3</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">-1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"sdiff"</span>,            sdiffCommand,            <span class="number">-2</span>, <span class="string">"rS"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">-1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"sdiffstore"</span>,       sdiffstoreCommand,       <span class="number">-3</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">-1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"smembers"</span>,         sinterCommand,           <span class="number">2</span>,  <span class="string">"rS"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"sscan"</span>,            sscanCommand,            <span class="number">-3</span>, <span class="string">"rR"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zadd"</span>,             zaddCommand,             <span class="number">-4</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zincrby"</span>,          zincrbyCommand,          <span class="number">4</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zrem"</span>,             zremCommand,             <span class="number">-3</span>, <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zremrangebyscore"</span>, zremrangebyscoreCommand, <span class="number">4</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zremrangebyrank"</span>,  zremrangebyrankCommand,  <span class="number">4</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zremrangebylex"</span>,   zremrangebylexCommand,   <span class="number">4</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zunionstore"</span>,      zunionstoreCommand,      <span class="number">-4</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, zunionInterGetKeys, <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zinterstore"</span>,      zinterstoreCommand,      <span class="number">-4</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, zunionInterGetKeys, <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zrange"</span>,           zrangeCommand,           <span class="number">-4</span>, <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zrangebyscore"</span>,    zrangebyscoreCommand,    <span class="number">-4</span>, <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zrevrangebyscore"</span>, zrevrangebyscoreCommand, <span class="number">-4</span>, <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zrangebylex"</span>,      zrangebylexCommand,      <span class="number">-4</span>, <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zrevrangebylex"</span>,   zrevrangebylexCommand,   <span class="number">-4</span>, <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zcount"</span>,           zcountCommand,           <span class="number">4</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zlexcount"</span>,        zlexcountCommand,        <span class="number">4</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zrevrange"</span>,        zrevrangeCommand,        <span class="number">-4</span>, <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zcard"</span>,            zcardCommand,            <span class="number">2</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zscore"</span>,           zscoreCommand,           <span class="number">3</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zrank"</span>,            zrankCommand,            <span class="number">3</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zrevrank"</span>,         zrevrankCommand,         <span class="number">3</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"zscan"</span>,            zscanCommand,            <span class="number">-3</span>, <span class="string">"rR"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"hset"</span>,             hsetCommand,             <span class="number">4</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"hsetnx"</span>,           hsetnxCommand,           <span class="number">4</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"hget"</span>,             hgetCommand,             <span class="number">3</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"hmset"</span>,            hmsetCommand,            <span class="number">-4</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"hmget"</span>,            hmgetCommand,            <span class="number">-3</span>, <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"hincrby"</span>,          hincrbyCommand,          <span class="number">4</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"hincrbyfloat"</span>,     hincrbyfloatCommand,     <span class="number">4</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"hdel"</span>,             hdelCommand,             <span class="number">-3</span>, <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"hlen"</span>,             hlenCommand,             <span class="number">2</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"hkeys"</span>,            hkeysCommand,            <span class="number">2</span>,  <span class="string">"rS"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"hvals"</span>,            hvalsCommand,            <span class="number">2</span>,  <span class="string">"rS"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"hgetall"</span>,          hgetallCommand,          <span class="number">2</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"hexists"</span>,          hexistsCommand,          <span class="number">3</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"hscan"</span>,            hscanCommand,            <span class="number">-3</span>, <span class="string">"rR"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"incrby"</span>,           incrbyCommand,           <span class="number">3</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"decrby"</span>,           decrbyCommand,           <span class="number">3</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"incrbyfloat"</span>,      incrbyfloatCommand,      <span class="number">3</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"getset"</span>,           getsetCommand,           <span class="number">3</span>,  <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"mset"</span>,             msetCommand,             <span class="number">-3</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">-1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"msetnx"</span>,           msetnxCommand,           <span class="number">-3</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">-1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"randomkey"</span>,        randomkeyCommand,        <span class="number">1</span>,  <span class="string">"rR"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"select"</span>,           selectCommand,           <span class="number">2</span>,  <span class="string">"rl"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"move"</span>,             moveCommand,             <span class="number">3</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"rename"</span>,           renameCommand,           <span class="number">3</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">2</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"renamenx"</span>,         renamenxCommand,         <span class="number">3</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">2</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"expire"</span>,           expireCommand,           <span class="number">3</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"expireat"</span>,         expireatCommand,         <span class="number">3</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"pexpire"</span>,          pexpireCommand,          <span class="number">3</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"pexpireat"</span>,        pexpireatCommand,        <span class="number">3</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"keys"</span>,             keysCommand,             <span class="number">2</span>,  <span class="string">"rS"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"scan"</span>,             scanCommand,             <span class="number">-2</span>, <span class="string">"rR"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"dbsize"</span>,           dbsizeCommand,           <span class="number">1</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"auth"</span>,             authCommand,             <span class="number">2</span>,  <span class="string">"rslt"</span>,  <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"ping"</span>,             pingCommand,             <span class="number">1</span>,  <span class="string">"rt"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"echo"</span>,             echoCommand,             <span class="number">2</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"save"</span>,             saveCommand,             <span class="number">1</span>,  <span class="string">"ars"</span>,   <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"bgsave"</span>,           bgsaveCommand,           <span class="number">1</span>,  <span class="string">"ar"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"bgrewriteaof"</span>,     bgrewriteaofCommand,     <span class="number">1</span>,  <span class="string">"ar"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"shutdown"</span>,         shutdownCommand,         <span class="number">-1</span>, <span class="string">"arlt"</span>,  <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"lastsave"</span>,         lastsaveCommand,         <span class="number">1</span>,  <span class="string">"rR"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"type"</span>,             typeCommand,             <span class="number">2</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"multi"</span>,            multiCommand,            <span class="number">1</span>,  <span class="string">"rs"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"exec"</span>,             execCommand,             <span class="number">1</span>,  <span class="string">"sM"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"discard"</span>,          discardCommand,          <span class="number">1</span>,  <span class="string">"rs"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"sync"</span>,             syncCommand,             <span class="number">1</span>,  <span class="string">"ars"</span>,   <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"psync"</span>,            syncCommand,             <span class="number">3</span>,  <span class="string">"ars"</span>,   <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"replconf"</span>,         replconfCommand,         <span class="number">-1</span>, <span class="string">"arslt"</span>, <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"flushdb"</span>,          flushdbCommand,          <span class="number">1</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"flushall"</span>,         flushallCommand,         <span class="number">1</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"sort"</span>,             sortCommand,             <span class="number">-2</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, sortGetKeys,        <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"info"</span>,             infoCommand,             <span class="number">-1</span>, <span class="string">"rlt"</span>,   <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"monitor"</span>,          monitorCommand,          <span class="number">1</span>,  <span class="string">"ars"</span>,   <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"ttl"</span>,              ttlCommand,              <span class="number">2</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"pttl"</span>,             pttlCommand,             <span class="number">2</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"persist"</span>,          persistCommand,          <span class="number">2</span>,  <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"slaveof"</span>,          slaveofCommand,          <span class="number">3</span>,  <span class="string">"ast"</span>,   <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"debug"</span>,            debugCommand,            <span class="number">-2</span>, <span class="string">"as"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"config"</span>,           configCommand,           <span class="number">-2</span>, <span class="string">"art"</span>,   <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"subscribe"</span>,        subscribeCommand,        <span class="number">-2</span>, <span class="string">"rpslt"</span>, <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"unsubscribe"</span>,      unsubscribeCommand,      <span class="number">-1</span>, <span class="string">"rpslt"</span>, <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"psubscribe"</span>,       psubscribeCommand,       <span class="number">-2</span>, <span class="string">"rpslt"</span>, <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"punsubscribe"</span>,     punsubscribeCommand,     <span class="number">-1</span>, <span class="string">"rpslt"</span>, <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"publish"</span>,          publishCommand,          <span class="number">3</span>,  <span class="string">"pltr"</span>,  <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"pubsub"</span>,           pubsubCommand,           <span class="number">-2</span>, <span class="string">"pltrR"</span>, <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"watch"</span>,            watchCommand,            <span class="number">-2</span>, <span class="string">"rs"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">-1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"unwatch"</span>,          unwatchCommand,          <span class="number">1</span>,  <span class="string">"rs"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"cluster"</span>,          clusterCommand,          <span class="number">-2</span>, <span class="string">"ar"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"restore"</span>,          restoreCommand,          <span class="number">-4</span>, <span class="string">"awm"</span>,   <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"restore-asking"</span>,   restoreCommand,          <span class="number">-4</span>, <span class="string">"awmk"</span>,  <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"migrate"</span>,          migrateCommand,          <span class="number">-6</span>, <span class="string">"aw"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"asking"</span>,           askingCommand,           <span class="number">1</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"readonly"</span>,         readonlyCommand,         <span class="number">1</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"readwrite"</span>,        readwriteCommand,        <span class="number">1</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"dump"</span>,             dumpCommand,             <span class="number">2</span>,  <span class="string">"ar"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"object"</span>,           objectCommand,           <span class="number">-2</span>, <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">2</span>, <span class="number">2</span>,  <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"client"</span>,           clientCommand,           <span class="number">-2</span>, <span class="string">"ar"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"eval"</span>,             evalCommand,             <span class="number">-3</span>, <span class="string">"s"</span>,     <span class="number">0</span>, evalGetKeys,        <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"evalsha"</span>,          evalShaCommand,          <span class="number">-3</span>, <span class="string">"s"</span>,     <span class="number">0</span>, evalGetKeys,        <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"slowlog"</span>,          slowlogCommand,          <span class="number">-2</span>, <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"script"</span>,           scriptCommand,           <span class="number">-2</span>, <span class="string">"ras"</span>,   <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"time"</span>,             timeCommand,             <span class="number">1</span>,  <span class="string">"rR"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"bitop"</span>,            bitopCommand,            <span class="number">-4</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">2</span>, <span class="number">-1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"bitcount"</span>,         bitcountCommand,         <span class="number">-2</span>, <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"bitpos"</span>,           bitposCommand,           <span class="number">-3</span>, <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"wait"</span>,             waitCommand,             <span class="number">3</span>,  <span class="string">"rs"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"pfselftest"</span>,       pfselftestCommand,       <span class="number">1</span>,  <span class="string">"r"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"pfadd"</span>,            pfaddCommand,            <span class="number">-2</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"pfcount"</span>,          pfcountCommand,          <span class="number">-2</span>, <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">1</span>,  <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"pfmerge"</span>,          pfmergeCommand,          <span class="number">-2</span>, <span class="string">"wm"</span>,    <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">1</span>, <span class="number">-1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">&#123;<span class="string">"pfdebug"</span>,          pfdebugCommand,          <span class="number">-3</span>, <span class="string">"w"</span>,     <span class="number">0</span>, <span class="literal">NULL</span>,               <span class="number">0</span>, <span class="number">0</span>,  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">populateCommandTable</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 命令的数量</span></span><br><span class="line">    <span class="keyword">int</span> numcommands = <span class="keyword">sizeof</span>(redisCommandTable) / <span class="keyword">sizeof</span>(struct redisCommand);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; numcommands; j++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 指定命令</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">redisCommand</span> *<span class="title">c</span> = <span class="title">redisCommandTable</span> + <span class="title">j</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取出字符串 FLAG</span></span><br><span class="line">        <span class="keyword">char</span> *f = c-&gt;sflags;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> retval1, retval2;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据字符串 FLAG 生成实际 FLAG</span></span><br><span class="line">        <span class="keyword">while</span> (*f != <span class="string">'\0'</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (*f) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'w'</span>:</span><br><span class="line">                    c-&gt;flags |= REDIS_CMD_WRITE;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'r'</span>:</span><br><span class="line">                    c-&gt;flags |= REDIS_CMD_READONLY;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'m'</span>:</span><br><span class="line">                    c-&gt;flags |= REDIS_CMD_DENYOOM;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'a'</span>:</span><br><span class="line">                    c-&gt;flags |= REDIS_CMD_ADMIN;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'p'</span>:</span><br><span class="line">                    c-&gt;flags |= REDIS_CMD_PUBSUB;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'s'</span>:</span><br><span class="line">                    c-&gt;flags |= REDIS_CMD_NOSCRIPT;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'R'</span>:</span><br><span class="line">                    c-&gt;flags |= REDIS_CMD_RANDOM;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'S'</span>:</span><br><span class="line">                    c-&gt;flags |= REDIS_CMD_SORT_FOR_SCRIPT;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'l'</span>:</span><br><span class="line">                    c-&gt;flags |= REDIS_CMD_LOADING;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'t'</span>:</span><br><span class="line">                    c-&gt;flags |= REDIS_CMD_STALE;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'M'</span>:</span><br><span class="line">                    c-&gt;flags |= REDIS_CMD_SKIP_MONITOR;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'k'</span>:</span><br><span class="line">                    c-&gt;flags |= REDIS_CMD_ASKING;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    redisPanic(<span class="string">"Unsupported command flag"</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            f++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将命令关联到命令表</span></span><br><span class="line">        retval1 = dictAdd(server.commands, sdsnew(c-&gt;name), c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将命令也关联到原始命令表, 原始命令表不会受 redis.conf 中命令改名的影响</span></span><br><span class="line">        retval2 = dictAdd(server.orig_commands, sdsnew(c-&gt;name), c);</span><br><span class="line"></span><br><span class="line">        redisAssert(retval1 == DICT_OK &amp;&amp; retval2 == DICT_OK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    前面那个常常的数组就是 redis 的所有命令，populateCommandTable 函数的作用是把这些命令放到 table 里面

- 最后把几个命令从 table 里查好记录一下，因为接下来 load config 的时候可能会用到

    <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server.delCommand = lookupCommandByCString(<span class="string">"del"</span>);</span><br><span class="line">server.multiCommand = lookupCommandByCString(<span class="string">"multi"</span>);</span><br><span class="line">server.lpushCommand = lookupCommandByCString(<span class="string">"lpush"</span>);</span><br><span class="line">server.lpopCommand = lookupCommandByCString(<span class="string">"lpop"</span>);</span><br><span class="line">server.rpopCommand = lookupCommandByCString(<span class="string">"rpop"</span>);</span><br></pre></td></tr></table></figure></code></pre><h3 id="3-如果服务器以-Sentinel-模式启动，那么进行-Sentinel-功能相关的初始化"><a href="#3-如果服务器以-Sentinel-模式启动，那么进行-Sentinel-功能相关的初始化" class="headerlink" title="3. 如果服务器以 Sentinel 模式启动，那么进行 Sentinel 功能相关的初始化"></a>3. 如果服务器以 Sentinel 模式启动，那么进行 Sentinel 功能相关的初始化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (server.sentinel_mode) &#123;</span><br><span class="line">    initSentinelConfig();</span><br><span class="line">    initSentinel();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-读命令行用户输入，进行配置"><a href="#4-读命令行用户输入，进行配置" class="headerlink" title="4. 读命令行用户输入，进行配置"></a>4. 读命令行用户输入，进行配置</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (argc &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> j = <span class="number">1</span>; <span class="comment">/* First option to parse in argv[] */</span></span><br><span class="line">    sds options = sdsempty();</span><br><span class="line">    <span class="keyword">char</span> *configfile = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Handle special options --help and --version */</span></span><br><span class="line">    <span class="comment">// 处理特殊选项 -h 、-v 和 --test-memory</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"-v"</span>) == <span class="number">0</span> ||</span><br><span class="line">        <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--version"</span>) == <span class="number">0</span>)</span><br><span class="line">        version();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--help"</span>) == <span class="number">0</span> ||</span><br><span class="line">        <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"-h"</span>) == <span class="number">0</span>)</span><br><span class="line">        usage();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--test-memory"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (argc == <span class="number">3</span>) &#123;</span><br><span class="line">            memtest(atoi(argv[<span class="number">2</span>]), <span class="number">50</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Please specify the amount of memory to test in megabytes.\n"</span>);</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Example: ./redis-server --test-memory 4096\n\n"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* First argument is the config file name? */</span></span><br><span class="line">    <span class="comment">// 如果第一个参数（argv[1]）不是以 "--" 开头</span></span><br><span class="line">    <span class="comment">// 那么它应该是一个配置文件</span></span><br><span class="line">    <span class="keyword">if</span> (argv[j][<span class="number">0</span>] != <span class="string">'-'</span> || argv[j][<span class="number">1</span>] != <span class="string">'-'</span>)</span><br><span class="line">        configfile = argv[j++];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* All the other options are parsed and conceptually appended to the</span></span><br><span class="line"><span class="comment">     * configuration file. For instance --port 6380 will generate the</span></span><br><span class="line"><span class="comment">     * string "port 6380\n" to be parsed after the actual file name</span></span><br><span class="line"><span class="comment">     * is parsed, if any. */</span></span><br><span class="line">    <span class="comment">// 对用户给定的其余选项进行分析，并将分析所得的字符串追加稍后载入的配置文件的内容之后</span></span><br><span class="line">    <span class="comment">// 比如 --port 6380 会被分析为 "port 6380\n"</span></span><br><span class="line">    <span class="keyword">while</span> (j != argc) &#123;</span><br><span class="line">        <span class="keyword">if</span> (argv[j][<span class="number">0</span>] == <span class="string">'-'</span> &amp;&amp; argv[j][<span class="number">1</span>] == <span class="string">'-'</span>) &#123;</span><br><span class="line">            <span class="comment">/* Option name */</span></span><br><span class="line">            <span class="keyword">if</span> (sdslen(options)) options = sdscat(options, <span class="string">"\n"</span>);</span><br><span class="line">            options = sdscat(options, argv[j] + <span class="number">2</span>);</span><br><span class="line">            options = sdscat(options, <span class="string">" "</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* Option argument */</span></span><br><span class="line">            options = sdscatrepr(options, argv[j], <span class="built_in">strlen</span>(argv[j]));</span><br><span class="line">            options = sdscat(options, <span class="string">" "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        j++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (configfile) server.configfile = getAbsolutePath(configfile);</span><br><span class="line">    <span class="comment">// 重置保存条件</span></span><br><span class="line">    resetServerSaveParams();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 载入配置文件， options 是前面分析出的给定选项</span></span><br><span class="line">    loadServerConfig(configfile, options);</span><br><span class="line">    sdsfree(options);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取配置文件的绝对路径</span></span><br><span class="line">    <span class="keyword">if</span> (configfile) server.configfile = getAbsolutePath(configfile);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    redisLog(REDIS_WARNING,</span><br><span class="line">             <span class="string">"Warning: no config file specified, using the default config. In order to specify a config file use %s /path/to/%s.conf"</span>,</span><br><span class="line">             argv[<span class="number">0</span>], server.sentinel_mode ? <span class="string">"sentinel"</span> : <span class="string">"redis"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果没指定 argv 参数，那么就 redisLog 一下就完了，重点看有参数的情况处理</p>
<ol>
<li><p>几种特殊情况，直接干完以后 exit</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理特殊选项 -h 、-v 和 --test-memory</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"-v"</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--version"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    version();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--help"</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"-h"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    usage();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--test-memory"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">3</span>) &#123;</span><br><span class="line">        memtest(atoi(argv[<span class="number">2</span>]), <span class="number">50</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Please specify the amount of memory to test in megabytes.\n"</span>);</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Example: ./redis-server --test-memory 4096\n\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来看看怎么解析的</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> j = <span class="number">1</span>; <span class="comment">/* First option to parse in argv[] */</span></span><br><span class="line">sds options = sdsempty();</span><br><span class="line"><span class="keyword">char</span> *configfile = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li><p>如果第一个参数（argv[1]）不是以 “–” 开头, 那么它应该是一个配置文件</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (argv[j][<span class="number">0</span>] != <span class="string">'-'</span> || argv[j][<span class="number">1</span>] != <span class="string">'-'</span>) &#123;</span><br><span class="line">    configfile = argv[j++];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来命令中的参数解析一下，拼到 options 后面</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对用户给定的其余选项进行分析，并将分析所得的字符串追加稍后载入的配置文件的内容之后</span></span><br><span class="line"><span class="comment">// 比如 --port 6380 会被分析为 "port 6380\n"</span></span><br><span class="line"><span class="keyword">while</span> (j != argc) &#123;</span><br><span class="line">    <span class="keyword">if</span> (argv[j][<span class="number">0</span>] == <span class="string">'-'</span> &amp;&amp; argv[j][<span class="number">1</span>] == <span class="string">'-'</span>) &#123;</span><br><span class="line">        <span class="comment">/* Option name */</span></span><br><span class="line">        <span class="keyword">if</span> (sdslen(options)) &#123;</span><br><span class="line">            options = sdscat(options, <span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        options = sdscat(options, argv[j] + <span class="number">2</span>);</span><br><span class="line">        options = sdscat(options, <span class="string">" "</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* Option argument */</span></span><br><span class="line">        options = sdscatrepr(options, argv[j], <span class="built_in">strlen</span>(argv[j]));</span><br><span class="line">        options = sdscat(options, <span class="string">" "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    j++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后如果有 config file 的话，把它打开，然后再把内容拼到字符串里面，再逐行拿出来配置 redis server 的参数</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 载入配置文件， options 是前面分析出的给定选项</span><br><span class="line">loadServerConfig(configfile, options);</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ol>
<h3 id="5-将服务器设置为守护进程"><a href="#5-将服务器设置为守护进程" class="headerlink" title="5. 将服务器设置为守护进程"></a>5. 将服务器设置为守护进程</h3><p>fork 出一个子进程，然后把所有标准 io 重定向到 /dev/null，接下来的所有操作都在子进程里面了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">daemonize</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fork() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>); <span class="comment">/* parent exits */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setsid(); <span class="comment">/* create a new session */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Every output goes to /dev/null. If Redis is daemonized but</span></span><br><span class="line"><span class="comment">     * the 'logfile' is set to 'stdout' in the configuration file</span></span><br><span class="line"><span class="comment">     * it will not log at all. */</span></span><br><span class="line">    <span class="keyword">if</span> ((fd = <span class="built_in">open</span>(<span class="string">"/dev/null"</span>, O_RDWR, <span class="number">0</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">        dup2(fd, STDIN_FILENO);</span><br><span class="line">        dup2(fd, STDOUT_FILENO);</span><br><span class="line">        dup2(fd, STDERR_FILENO);</span><br><span class="line">        <span class="keyword">if</span> (fd &gt; STDERR_FILENO) &#123;</span><br><span class="line">            <span class="built_in">close</span>(fd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-创建并初始化服务器数据结构"><a href="#6-创建并初始化服务器数据结构" class="headerlink" title="6. 创建并初始化服务器数据结构"></a>6. 创建并初始化服务器数据结构</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置信号处理函数</span></span><br><span class="line">    signal(SIGHUP, SIG_IGN);</span><br><span class="line">    signal(SIGPIPE, SIG_IGN);</span><br><span class="line">    setupSignalHandlers();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 syslog</span></span><br><span class="line">    <span class="keyword">if</span> (server.syslog_enabled) &#123;</span><br><span class="line">        openlog(server.syslog_ident, LOG_PID | LOG_NDELAY | LOG_NOWAIT,</span><br><span class="line">                server.syslog_facility);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化并创建数据结构</span></span><br><span class="line">    server.current_client = <span class="literal">NULL</span>;</span><br><span class="line">    server.clients = listCreate();</span><br><span class="line">    server.clients_to_close = listCreate();</span><br><span class="line">    server.slaves = listCreate();</span><br><span class="line">    server.monitors = listCreate();</span><br><span class="line">    server.slaveseldb = <span class="number">-1</span>; <span class="comment">/* Force to emit the first SELECT command. */</span></span><br><span class="line">    server.unblocked_clients = listCreate();</span><br><span class="line">    server.ready_keys = listCreate();</span><br><span class="line">    server.clients_waiting_acks = listCreate();</span><br><span class="line">    server.get_ack_from_slaves = <span class="number">0</span>;</span><br><span class="line">    server.clients_paused = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建共享对象</span></span><br><span class="line">    createSharedObjects();</span><br><span class="line">    adjustOpenFilesLimit();</span><br><span class="line">    server.el = aeCreateEventLoop(server.maxclients + REDIS_EVENTLOOP_FDSET_INCR);</span><br><span class="line">    server.db = zmalloc(<span class="keyword">sizeof</span>(redisDb) * server.dbnum);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Open the TCP listening socket for the user commands. */</span></span><br><span class="line">    <span class="comment">// 打开 TCP 监听端口，用于等待客户端的命令请求</span></span><br><span class="line">    <span class="keyword">if</span> (server.port != <span class="number">0</span> &amp;&amp;</span><br><span class="line">        listenToPort(server.port, server.ipfd, &amp;server.ipfd_count) == REDIS_ERR)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Open the listening Unix domain socket. */</span></span><br><span class="line">    <span class="comment">// 打开 UNIX 本地端口</span></span><br><span class="line">    <span class="keyword">if</span> (server.unixsocket != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        unlink(server.unixsocket); <span class="comment">/* don't care if this fails */</span></span><br><span class="line">        server.sofd = anetUnixServer(server.neterr, server.unixsocket,</span><br><span class="line">                                     server.unixsocketperm, server.tcp_backlog);</span><br><span class="line">        <span class="keyword">if</span> (server.sofd == ANET_ERR) &#123;</span><br><span class="line">            redisLog(REDIS_WARNING, <span class="string">"Opening socket: %s"</span>, server.neterr);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        anetNonBlock(<span class="literal">NULL</span>, server.sofd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Abort if there are no listening sockets at all. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.ipfd_count == <span class="number">0</span> &amp;&amp; server.sofd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        redisLog(REDIS_WARNING, <span class="string">"Configured to not listen anywhere, exiting."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create the Redis databases, and initialize other internal state. */</span></span><br><span class="line">    <span class="comment">// 创建并初始化数据库结构</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.dbnum; j++) &#123;</span><br><span class="line">        server.db[j].dict = dictCreate(&amp;dbDictType, <span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].expires = dictCreate(&amp;keyptrDictType, <span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].blocking_keys = dictCreate(&amp;keylistDictType, <span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].ready_keys = dictCreate(&amp;setDictType, <span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].watched_keys = dictCreate(&amp;keylistDictType, <span class="literal">NULL</span>);</span><br><span class="line">        server.db[j].eviction_pool = evictionPoolAlloc();</span><br><span class="line">        server.db[j].id = j;</span><br><span class="line">        server.db[j].avg_ttl = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 PUBSUB 相关结构</span></span><br><span class="line">    server.pubsub_channels = dictCreate(&amp;keylistDictType, <span class="literal">NULL</span>);</span><br><span class="line">    server.pubsub_patterns = listCreate();</span><br><span class="line">    listSetFreeMethod(server.pubsub_patterns, freePubsubPattern);</span><br><span class="line">    listSetMatchMethod(server.pubsub_patterns, listMatchPubsubPattern);</span><br><span class="line"></span><br><span class="line">    server.cronloops = <span class="number">0</span>;</span><br><span class="line">    server.rdb_child_pid = <span class="number">-1</span>;</span><br><span class="line">    server.aof_child_pid = <span class="number">-1</span>;</span><br><span class="line">    aofRewriteBufferReset();</span><br><span class="line">    server.aof_buf = sdsempty();</span><br><span class="line">    server.lastsave = time(<span class="literal">NULL</span>); <span class="comment">/* At startup we consider the DB saved. */</span></span><br><span class="line">    server.lastbgsave_try = <span class="number">0</span>;    <span class="comment">/* At startup we never tried to BGSAVE. */</span></span><br><span class="line">    server.rdb_save_time_last = <span class="number">-1</span>;</span><br><span class="line">    server.rdb_save_time_start = <span class="number">-1</span>;</span><br><span class="line">    server.dirty = <span class="number">0</span>;</span><br><span class="line">    resetServerStats();</span><br><span class="line">    <span class="comment">/* A few stats we don't want to reset: server startup time, and peak mem. */</span></span><br><span class="line">    server.stat_starttime = time(<span class="literal">NULL</span>);</span><br><span class="line">    server.stat_peak_memory = <span class="number">0</span>;</span><br><span class="line">    server.resident_set_size = <span class="number">0</span>;</span><br><span class="line">    server.lastbgsave_status = REDIS_OK;</span><br><span class="line">    server.aof_last_write_status = REDIS_OK;</span><br><span class="line">    server.aof_last_write_errno = <span class="number">0</span>;</span><br><span class="line">    server.repl_good_slaves_count = <span class="number">0</span>;</span><br><span class="line">    updateCachedTime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create the serverCron() time event, that's our main way to process</span></span><br><span class="line"><span class="comment">     * background operations. */</span></span><br><span class="line">    <span class="comment">// 为 serverCron() 创建时间事件</span></span><br><span class="line">    <span class="keyword">if</span> (aeCreateTimeEvent(server.el, <span class="number">1</span>, serverCron, <span class="literal">NULL</span>, <span class="literal">NULL</span>) == AE_ERR) &#123;</span><br><span class="line">        redisPanic(<span class="string">"Can't create the serverCron time event."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create an event handler for accepting new connections in TCP and Unix</span></span><br><span class="line"><span class="comment">     * domain sockets. */</span></span><br><span class="line">    <span class="comment">// 为 TCP 连接关联连接应答（accept）处理器</span></span><br><span class="line">    <span class="comment">// 用于接受并应答客户端的 connect() 调用</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.ipfd_count; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (aeCreateFileEvent(server.el, server.ipfd[j], AE_READABLE,</span><br><span class="line">                              acceptTcpHandler, <span class="literal">NULL</span>) == AE_ERR) &#123;</span><br><span class="line">            redisPanic(</span><br><span class="line">                    <span class="string">"Unrecoverable error creating server.ipfd file event."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为本地套接字关联应答处理器</span></span><br><span class="line">    <span class="keyword">if</span> (server.sofd &gt; <span class="number">0</span> &amp;&amp; aeCreateFileEvent(server.el, server.sofd, AE_READABLE,</span><br><span class="line">                                             acceptUnixHandler, <span class="literal">NULL</span>) == AE_ERR)</span><br><span class="line">        redisPanic(<span class="string">"Unrecoverable error creating server.sofd file event."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Open the AOF file if needed. */</span></span><br><span class="line">    <span class="comment">// 如果 AOF 持久化功能已经打开，那么打开或创建一个 AOF 文件</span></span><br><span class="line">    <span class="keyword">if</span> (server.aof_state == REDIS_AOF_ON) &#123;</span><br><span class="line">        server.aof_fd = <span class="built_in">open</span>(server.aof_filename,</span><br><span class="line">                             O_WRONLY | O_APPEND | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">        <span class="keyword">if</span> (server.aof_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">            redisLog(REDIS_WARNING, <span class="string">"Can't open the append-only file: %s"</span>,</span><br><span class="line">                     strerror(errno));</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 32 bit instances are limited to 4GB of address space, so if there is</span></span><br><span class="line"><span class="comment">     * no explicit limit in the user provided configuration we set a limit</span></span><br><span class="line"><span class="comment">     * at 3 GB using maxmemory with 'noeviction' policy'. This avoids</span></span><br><span class="line"><span class="comment">     * useless crashes of the Redis instance for out of memory. */</span></span><br><span class="line">    <span class="comment">// 对于 32 位实例来说，默认将最大可用内存限制在 3 GB</span></span><br><span class="line">    <span class="keyword">if</span> (server.arch_bits == <span class="number">32</span> &amp;&amp; server.maxmemory == <span class="number">0</span>) &#123;</span><br><span class="line">        redisLog(REDIS_WARNING,</span><br><span class="line">                 <span class="string">"Warning: 32 bit instance detected but no memory limit set. Setting 3 GB maxmemory limit with 'noeviction' policy now."</span>);</span><br><span class="line">        server.maxmemory = <span class="number">3072L</span>L * (<span class="number">1024</span> * <span class="number">1024</span>); <span class="comment">/* 3 GB */</span></span><br><span class="line">        server.maxmemory_policy = REDIS_MAXMEMORY_NO_EVICTION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果服务器以 cluster 模式打开，那么初始化 cluster</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster_enabled) clusterInit();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化复制功能有关的脚本缓存</span></span><br><span class="line">    replicationScriptCacheInit();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化脚本系统</span></span><br><span class="line">    scriptingInit();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化慢查询功能</span></span><br><span class="line">    slowlogInit();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 BIO 系统</span></span><br><span class="line">    bioInit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数很长，分段看一下。</p>
<ol>
<li><p>设置各种信号处理函数</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">signal(SIGHUP, SIG_IGN);</span><br><span class="line">signal(SIGPIPE, SIG_IGN);</span><br><span class="line"></span><br><span class="line">setupSignalHandlers();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setupSignalHandlers</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line"></span><br><span class="line">    sigemptyset(&amp;act.sa_mask);</span><br><span class="line">    act.sa_flags = <span class="number">0</span>;</span><br><span class="line">    act.sa_handler = sigtermHandler;</span><br><span class="line">    sigaction(SIGTERM, &amp;act, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_BACKTRACE</span></span><br><span class="line">    sigemptyset(&amp;act.sa_mask);</span><br><span class="line">    act.sa_flags = SA_NODEFER | SA_RESETHAND | SA_SIGINFO;</span><br><span class="line">    act.sa_sigaction = sigsegvHandler;</span><br><span class="line"></span><br><span class="line">    sigaction(SIGSEGV, &amp;act, <span class="literal">NULL</span>);</span><br><span class="line">    sigaction(SIGBUS, &amp;act, <span class="literal">NULL</span>);</span><br><span class="line">    sigaction(SIGFPE, &amp;act, <span class="literal">NULL</span>);</span><br><span class="line">    sigaction(SIGILL, &amp;act, <span class="literal">NULL</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SIGTERM 信号的处理器</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sigtermHandler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">    REDIS_NOTUSED(sig);</span><br><span class="line"></span><br><span class="line">    redisLogFromHandler(REDIS_WARNING, <span class="string">"Received SIGTERM, scheduling shutdown..."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开关闭标识</span></span><br><span class="line">    server.shutdown_asap = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置 syslog</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (server.syslog_enabled) &#123;</span><br><span class="line">    openlog(server.syslog_ident, LOG_PID | LOG_NDELAY | LOG_NOWAIT,</span><br><span class="line">            server.syslog_facility);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化并创建数据结构</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server.current_client = <span class="literal">NULL</span>;</span><br><span class="line">server.clients = listCreate();</span><br><span class="line">server.clients_to_close = listCreate();</span><br><span class="line">server.slaves = listCreate();</span><br><span class="line">server.monitors = listCreate();</span><br><span class="line">server.slaveseldb = <span class="number">-1</span>; <span class="comment">/* Force to emit the first SELECT command. */</span></span><br><span class="line">server.unblocked_clients = listCreate();</span><br><span class="line">server.ready_keys = listCreate();</span><br><span class="line">server.clients_waiting_acks = listCreate();</span><br><span class="line">server.get_ack_from_slaves = <span class="number">0</span>;</span><br><span class="line">server.clients_paused = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建共享对象</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createSharedObjects();</span><br></pre></td></tr></table></figure>

<p> 这个函数里面把 struct sharedObjectsStruct shared 构造好，这个结构体包含了常见的命令回复</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过复用来减少内存碎片，以及减少操作耗时的共享对象</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sharedObjectsStruct</span> &#123;</span></span><br><span class="line">    robj *crlf, *ok, *err, *emptybulk, *czero, *cone, *cnegone, *pong, *space,</span><br><span class="line">        *colon, *nullbulk, *nullmultibulk, *queued,</span><br><span class="line">        *emptymultibulk, *wrongtypeerr, *nokeyerr, *syntaxerr, *sameobjecterr,</span><br><span class="line">        *outofrangeerr, *noscripterr, *loadingerr, *slowscripterr, *bgsaveerr,</span><br><span class="line">        *masterdownerr, *roslaveerr, *execaborterr, *noautherr, *noreplicaserr,</span><br><span class="line">        *busykeyerr, *oomerr, *plus, *messagebulk, *pmessagebulk, *subscribebulk,</span><br><span class="line">        *unsubscribebulk, *psubscribebulk, *punsubscribebulk, *del, *rpop, *lpop,</span><br><span class="line">        *lpush, *emptyscan, *minstring, *maxstring,</span><br><span class="line">        *select[REDIS_SHARED_SELECT_CMDS],</span><br><span class="line">        *integers[REDIS_SHARED_INTEGERS],</span><br><span class="line">        *mbulkhdr[REDIS_SHARED_BULKHDR_LEN], <span class="comment">/* "*&lt;value&gt;\r\n" */</span></span><br><span class="line">        *bulkhdr[REDIS_SHARED_BULKHDR_LEN];  <span class="comment">/* "$&lt;value&gt;\r\n" */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化事件处理器状态</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">server.el = aeCreateEventLoop(server.maxclients + REDIS_EVENTLOOP_FDSET_INCR);</span><br><span class="line"></span><br><span class="line"><span class="function">aeEventLoop *<span class="title">aeCreateEventLoop</span><span class="params">(<span class="keyword">int</span> setsize)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    aeEventLoop *eventLoop;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建事件状态结构</span></span><br><span class="line">    <span class="keyword">if</span> ((eventLoop = zmalloc(<span class="keyword">sizeof</span>(*eventLoop))) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化文件事件结构和已就绪文件事件结构数组</span></span><br><span class="line">    eventLoop-&gt;events = zmalloc(<span class="keyword">sizeof</span>(aeFileEvent) * setsize);</span><br><span class="line">    eventLoop-&gt;fired = zmalloc(<span class="keyword">sizeof</span>(aeFiredEvent) * setsize);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (eventLoop-&gt;events == <span class="literal">NULL</span> || eventLoop-&gt;fired == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置数组大小</span></span><br><span class="line">    eventLoop-&gt;setsize = setsize;</span><br><span class="line">    <span class="comment">// 初始化执行最近一次执行时间</span></span><br><span class="line">    eventLoop-&gt;lastTime = time(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化时间事件结构</span></span><br><span class="line">    eventLoop-&gt;timeEventHead = <span class="literal">NULL</span>;</span><br><span class="line">    eventLoop-&gt;timeEventNextId = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    eventLoop-&gt;<span class="built_in">stop</span> = <span class="number">0</span>;</span><br><span class="line">    eventLoop-&gt;maxfd = <span class="number">-1</span>;</span><br><span class="line">    eventLoop-&gt;beforesleep = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (aeApiCreate(eventLoop) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化监听事件</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; setsize; i++) &#123;</span><br><span class="line">        eventLoop-&gt;events[i].mask = AE_NONE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回事件循环</span></span><br><span class="line">    <span class="keyword">return</span> eventLoop;</span><br><span class="line"></span><br><span class="line">    err:</span><br><span class="line">    <span class="keyword">if</span> (eventLoop) &#123;</span><br><span class="line">        zfree(eventLoop-&gt;events);</span><br><span class="line">        zfree(eventLoop-&gt;fired);</span><br><span class="line">        zfree(eventLoop);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 这个方法之前看过，底层是 IO 多路复用库，创建一个 eventloop 来监听端口</p>
</li>
<li><p>打开 TCP 监听端口，用于等待客户端的命令请求</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">listenToPort(server.port, server.ipfd, &amp;server.ipfd_count);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">listenToPort</span><span class="params">(<span class="keyword">int</span> port, <span class="keyword">int</span> *fds, <span class="keyword">int</span> *count)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.bindaddr_count == <span class="number">0</span>) server.bindaddr[<span class="number">0</span>] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.bindaddr_count || j == <span class="number">0</span>; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (server.bindaddr[j] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            fds[*count] = anetTcp6Server(server.neterr, port, <span class="literal">NULL</span>, server.tcp_backlog);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fds[*count] != ANET_ERR) &#123;</span><br><span class="line">                anetNonBlock(<span class="literal">NULL</span>, fds[*count]);</span><br><span class="line">                (*count)++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fds[*count] = anetTcpServer(server.neterr, port, <span class="literal">NULL</span>, server.tcp_backlog);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fds[*count] != ANET_ERR) &#123;</span><br><span class="line">                anetNonBlock(<span class="literal">NULL</span>, fds[*count]);</span><br><span class="line">                (*count)++;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">if</span> (*count) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strchr</span>(server.bindaddr[j], <span class="string">':'</span>)) &#123;</span><br><span class="line">        </span><br><span class="line">            fds[*count] = anetTcp6Server(server.neterr, port, server.bindaddr[j], server.tcp_backlog);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line">            fds[*count] = anetTcpServer(server.neterr, port, server.bindaddr[j], server.tcp_backlog);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fds[*count] == ANET_ERR) &#123;</span><br><span class="line">            redisLog(REDIS_WARNING,</span><br><span class="line">                 <span class="string">"Creating Server TCP listening socket %s:%d: %s"</span>,</span><br><span class="line">                 server.bindaddr[j] ? server.bindaddr[j] : <span class="string">"*"</span>,</span><br><span class="line">                 port, server.neterr);</span><br><span class="line">            <span class="keyword">return</span> REDIS_ERR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        anetNonBlock(<span class="literal">NULL</span>, fds[*count]);</span><br><span class="line">        (*count)++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> REDIS_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 这个方法初始化一组文件描述符以侦听指定的“端口”，绑定Redis服务器配置中指定的地址，并设置为非阻塞。</p>
</li>
<li><p>打开 UNIX 本地端口</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (server.unixsocket != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    unlink(server.unixsocket); <span class="comment">/* don't care if this fails */</span></span><br><span class="line">    server.sofd = anetUnixServer(server.neterr, server.unixsocket,</span><br><span class="line">                                 server.unixsocketperm, server.tcp_backlog);</span><br><span class="line">    <span class="keyword">if</span> (server.sofd == ANET_ERR) &#123;</span><br><span class="line">        redisLog(REDIS_WARNING, <span class="string">"Opening socket: %s"</span>, server.neterr);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    anetNonBlock(<span class="literal">NULL</span>, server.sofd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建并初始化数据库结构</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.dbnum; j++) &#123;</span><br><span class="line">    server.db[j].dict = dictCreate(&amp;dbDictType, <span class="literal">NULL</span>);</span><br><span class="line">    server.db[j].expires = dictCreate(&amp;keyptrDictType, <span class="literal">NULL</span>);</span><br><span class="line">    server.db[j].blocking_keys = dictCreate(&amp;keylistDictType, <span class="literal">NULL</span>);</span><br><span class="line">    server.db[j].ready_keys = dictCreate(&amp;setDictType, <span class="literal">NULL</span>);</span><br><span class="line">    server.db[j].watched_keys = dictCreate(&amp;keylistDictType, <span class="literal">NULL</span>);</span><br><span class="line">    server.db[j].eviction_pool = evictionPoolAlloc();</span><br><span class="line">    server.db[j].id = j;</span><br><span class="line">    server.db[j].avg_ttl = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建时间事件</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aeCreateTimeEvent(server.el, <span class="number">1</span>, serverCron, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意到这里周期是 1ms，靠的是后面的 run_with_period 来控制具体周期</p>
</blockquote>
<p> 这里面的重点是 serverCron 函数，这个函数相当长，看看 run_with_period 挺好的：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">run_with_period(<span class="number">100</span>) &#123;</span><br><span class="line">    trackOperationsPerSecond();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> run_with_period(_ms_) <span class="meta-keyword">if</span> ((_ms_ &lt;= 1000/server.hz) || !(server.cronloops%((_ms_)/(1000/server.hz))))</span></span><br></pre></td></tr></table></figure>

<p> run_with_period 本身是一个宏，server.cronloops 每转一圈会自增。</p>
</li>
<li><p>为 TCP 连接关联连接应答（accept）处理器，用于接受并应答客户端的 connect() 调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.ipfd_count; j++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (aeCreateFileEvent(server.el, server.ipfd[j], AE_READABLE,</span><br><span class="line">                          acceptTcpHandler, <span class="literal">NULL</span>) == AE_ERR) &#123;</span><br><span class="line">        redisPanic(</span><br><span class="line">                <span class="string">"Unrecoverable error creating server.ipfd file event."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>为本地套接字关联应答处理器</p>
<blockquote>
<p>注：例如 lua 脚本需要伪客户端</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (server.sofd &gt; <span class="number">0</span> &amp;&amp; aeCreateFileEvent(</span><br><span class="line">        server.el, server.sofd, AE_READABLE,</span><br><span class="line">        acceptUnixHandler, <span class="literal">NULL</span>) == AE_ERR) &#123;</span><br><span class="line">    redisPanic(<span class="string">"Unrecoverable error creating server.sofd file event."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果 AOF 持久化功能已经打开，那么打开或创建一个 AOF 文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (server.aof_state == REDIS_AOF_ON) &#123;</span><br><span class="line">    server.aof_fd = <span class="built_in">open</span>(server.aof_filename,</span><br><span class="line">                         O_WRONLY | O_APPEND | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">if</span> (server.aof_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        redisLog(REDIS_WARNING, <span class="string">"Can't open the append-only file: %s"</span>,</span><br><span class="line">                 strerror(errno));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>集群、复制功能相关</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (server.arch_bits == <span class="number">32</span> &amp;&amp; server.maxmemory == <span class="number">0</span>) &#123;</span><br><span class="line">    redisLog(REDIS_WARNING,</span><br><span class="line">             <span class="string">"Warning: 32 bit instance detected but no memory limit set. Setting 3 GB maxmemory limit with 'noeviction' policy now."</span>);</span><br><span class="line">    server.maxmemory = <span class="number">3072L</span>L * (<span class="number">1024</span> * <span class="number">1024</span>); <span class="comment">/* 3 GB */</span></span><br><span class="line">    server.maxmemory_policy = REDIS_MAXMEMORY_NO_EVICTION;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果服务器以 cluster 模式打开，那么初始化 cluster</span></span><br><span class="line"><span class="keyword">if</span> (server.cluster_enabled) &#123;</span><br><span class="line">    clusterInit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化复制功能有关的脚本缓存</span></span><br><span class="line">replicationScriptCacheInit();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化脚本系统</span></span><br><span class="line">scriptingInit();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化慢查询功能</span></span><br><span class="line">slowlogInit();</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化 BIO 系统</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bioInit();</span><br></pre></td></tr></table></figure>

<p>这个函数是用于初始化线程和临界区</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pthread_attr_t</span> attr;</span><br><span class="line"><span class="keyword">pthread_t</span> thread;</span><br><span class="line"><span class="keyword">size_t</span> stacksize;</span><br><span class="line"><span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Initialization of state vars and objects </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 初始化 job 队列，以及线程状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; REDIS_BIO_NUM_OPS; j++) &#123;</span><br><span class="line">    pthread_mutex_init(&amp;bio_mutex[j],<span class="literal">NULL</span>);</span><br><span class="line">    pthread_cond_init(&amp;bio_condvar[j],<span class="literal">NULL</span>);</span><br><span class="line">    bio_jobs[j] = listCreate();</span><br><span class="line">    bio_pending[j] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set the stack size as by default it may be small in some system </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 设置栈大小</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">pthread_attr_init(&amp;attr);</span><br><span class="line">pthread_attr_getstacksize(&amp;attr,&amp;stacksize);</span><br><span class="line"><span class="keyword">if</span> (!stacksize) stacksize = <span class="number">1</span>; <span class="comment">/* The world is full of Solaris Fixes */</span></span><br><span class="line"><span class="keyword">while</span> (stacksize &lt; REDIS_THREAD_STACK_SIZE) stacksize *= <span class="number">2</span>;</span><br><span class="line">pthread_attr_setstacksize(&amp;attr, stacksize);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Ready to spawn our threads. We use the single argument the thread</span></span><br><span class="line"><span class="comment"> * function accepts in order to pass the job ID the thread is</span></span><br><span class="line"><span class="comment"> * responsible of. </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 创建线程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; REDIS_BIO_NUM_OPS; j++) &#123;</span><br><span class="line">    <span class="keyword">void</span> *arg = (<span class="keyword">void</span>*)(<span class="keyword">unsigned</span> <span class="keyword">long</span>) j;</span><br><span class="line">    <span class="keyword">if</span> (pthread_create(&amp;thread,&amp;attr,bioProcessBackgroundJobs,arg) != <span class="number">0</span>) &#123;</span><br><span class="line">        redisLog(REDIS_WARNING,<span class="string">"Fatal: Can't initialize Background Jobs."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    bio_threads[j] = thread;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，<strong>Redis 不是完全的单线程</strong>，会<strong>开两个后台线程</strong>：</p>
<ul>
<li><p>后台线程的作用是</p>
<ul>
<li>aof 的 fsync 系统调用</li>
<li>文件的最后一个 owner 对文件进行 close</li>
</ul>
</li>
<li><p>实现方式是临界区放一个 list，生产者-消费者模式</p>
</li>
</ul>
</li>
</ol>
<h3 id="7-如果服务器是守护进程，那么创建-PID-文件"><a href="#7-如果服务器是守护进程，那么创建-PID-文件" class="headerlink" title="7. 如果服务器是守护进程，那么创建 PID 文件"></a>7. 如果服务器是守护进程，那么创建 PID 文件</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (server.daemonize) &#123;</span><br><span class="line">    createPidFile();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createPidFile</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* Try to write the pid file in a best-effort way. */</span></span><br><span class="line">    FILE *fp = fopen(server.pidfile, <span class="string">"w"</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(fp, <span class="string">"%d\n"</span>, (<span class="keyword">int</span>) getpid());</span><br><span class="line">        fclose(fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-为服务器进程设置名字"><a href="#8-为服务器进程设置名字" class="headerlink" title="8. 为服务器进程设置名字"></a>8. 为服务器进程设置名字</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">redisSetProcTitle(argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">redisSetProcTitle</span><span class="params">(<span class="keyword">char</span> *title)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_SETPROCTITLE</span></span><br><span class="line">    <span class="keyword">char</span> *server_mode = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (server.cluster_enabled) server_mode = <span class="string">" [cluster]"</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (server.sentinel_mode) server_mode = <span class="string">" [sentinel]"</span>;</span><br><span class="line"></span><br><span class="line">    setproctitle(<span class="string">"%s %s:%d%s"</span>,</span><br><span class="line">        title,</span><br><span class="line">        server.bindaddr_count ? server.bindaddr[<span class="number">0</span>] : <span class="string">"*"</span>,</span><br><span class="line">        server.port,</span><br><span class="line">        server_mode);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    REDIS_NOTUSED(title);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-打印-ASCII-LOGO"><a href="#9-打印-ASCII-LOGO" class="headerlink" title="9. 打印 ASCII LOGO"></a>9. 打印 ASCII LOGO</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">redisAsciiArt</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"asciilogo.h"</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *buf = zmalloc(<span class="number">1024</span> * <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">char</span> *mode = <span class="string">"stand alone"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.cluster_enabled) &#123;</span><br><span class="line">        mode = <span class="string">"cluster"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (server.sentinel_mode) &#123;</span><br><span class="line">        mode = <span class="string">"sentinel"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(buf, <span class="number">1024</span> * <span class="number">16</span>, ascii_logo,</span><br><span class="line">             REDIS_VERSION,</span><br><span class="line">             redisGitSHA1(),</span><br><span class="line">             strtol(redisGitDirty(), <span class="literal">NULL</span>, <span class="number">10</span>) &gt; <span class="number">0</span>,</span><br><span class="line">             (<span class="keyword">sizeof</span>(<span class="keyword">long</span>) == <span class="number">8</span>) ? <span class="string">"64"</span> : <span class="string">"32"</span>,</span><br><span class="line">             mode, server.port,</span><br><span class="line">             (<span class="keyword">long</span>) getpid()</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    redisLogRaw(REDIS_NOTICE | REDIS_LOG_RAW, buf);</span><br><span class="line">    zfree(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-载入-rdb-和-aof-文件"><a href="#10-载入-rdb-和-aof-文件" class="headerlink" title="10. 载入 rdb 和 aof 文件"></a>10. 载入 rdb 和 aof 文件</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loadDataFromDisk();</span><br></pre></td></tr></table></figure>

<p>这里面分为 2 种， aof 和 rdb</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loadDataFromDisk</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 记录开始时间</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> start = ustime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AOF 持久化已打开？</span></span><br><span class="line">    <span class="keyword">if</span> (server.aof_state == REDIS_AOF_ON) &#123;</span><br><span class="line">        <span class="comment">// 尝试载入 AOF 文件</span></span><br><span class="line">        <span class="keyword">if</span> (loadAppendOnlyFile(server.aof_filename) == REDIS_OK)</span><br><span class="line">            <span class="comment">// 打印载入信息，并计算载入耗时长度</span></span><br><span class="line">            redisLog(REDIS_NOTICE, <span class="string">"DB loaded from append only file: %.3f seconds"</span>,</span><br><span class="line">                     (<span class="keyword">float</span>) (ustime() - start) / <span class="number">1000000</span>);</span><br><span class="line">        <span class="comment">// AOF 持久化未打开</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 尝试载入 RDB 文件</span></span><br><span class="line">        <span class="keyword">if</span> (rdbLoad(server.rdb_filename) == REDIS_OK) &#123;</span><br><span class="line">            <span class="comment">// 打印载入信息，并计算载入耗时长度</span></span><br><span class="line">            redisLog(REDIS_NOTICE, <span class="string">"DB loaded from disk: %.3f seconds"</span>,</span><br><span class="line">                     (<span class="keyword">float</span>) (ustime() - start) / <span class="number">1000000</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (errno != ENOENT) &#123;</span><br><span class="line">            redisLog(REDIS_WARNING, <span class="string">"Fatal error loading the DB: %s. Exiting."</span>, strerror(errno));</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-设置-before-sleep-方法"><a href="#11-设置-before-sleep-方法" class="headerlink" title="11. 设置 before sleep 方法"></a>11. 设置 before sleep 方法</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aeSetBeforeSleepProc(server.el, beforeSleep);</span><br></pre></td></tr></table></figure>

<p>这个方法是每一圈 loop 之前执行的方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">beforeSleep</span><span class="params">(struct aeEventLoop *eventLoop)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    REDIS_NOTUSED(eventLoop);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Run a fast expire cycle (the called function will return</span></span><br><span class="line"><span class="comment">     * ASAP if a fast cycle is not needed). */</span></span><br><span class="line">    <span class="comment">// 执行一次快速的主动过期检查</span></span><br><span class="line">    <span class="keyword">if</span> (server.active_expire_enabled &amp;&amp; server.masterhost == <span class="literal">NULL</span>)</span><br><span class="line">        activeExpireCycle(ACTIVE_EXPIRE_CYCLE_FAST);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Send all the slaves an ACK request if at least one client blocked</span></span><br><span class="line"><span class="comment">     * during the previous event loop iteration. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.get_ack_from_slaves) &#123;</span><br><span class="line">        robj *argv[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">        argv[<span class="number">0</span>] = createStringObject(<span class="string">"REPLCONF"</span>, <span class="number">8</span>);</span><br><span class="line">        argv[<span class="number">1</span>] = createStringObject(<span class="string">"GETACK"</span>, <span class="number">6</span>);</span><br><span class="line">        argv[<span class="number">2</span>] = createStringObject(<span class="string">"*"</span>, <span class="number">1</span>); <span class="comment">/* Not used argument. */</span></span><br><span class="line"></span><br><span class="line">        replicationFeedSlaves(server.slaves, server.slaveseldb, argv, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        decrRefCount(argv[<span class="number">0</span>]);</span><br><span class="line">        decrRefCount(argv[<span class="number">1</span>]);</span><br><span class="line">        decrRefCount(argv[<span class="number">2</span>]);</span><br><span class="line">        server.get_ack_from_slaves = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Unblock all the clients blocked for synchronous replication</span></span><br><span class="line"><span class="comment">     * in WAIT. */</span></span><br><span class="line">    <span class="keyword">if</span> (listLength(server.clients_waiting_acks))</span><br><span class="line">        processClientsWaitingReplicas();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Try to process pending commands for clients that were just unblocked. */</span></span><br><span class="line">    <span class="keyword">if</span> (listLength(server.unblocked_clients))</span><br><span class="line">        processUnblockedClients();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Write the AOF buffer on disk */</span></span><br><span class="line">    <span class="comment">// 将 AOF 缓冲区的内容写入到 AOF 文件</span></span><br><span class="line">    flushAppendOnlyFile(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Call the Redis Cluster before sleep function. */</span></span><br><span class="line">    <span class="comment">// 在进入下个事件循环前，执行一些集群收尾工作</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster_enabled) &#123;</span><br><span class="line">        clusterBeforeSleep();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中一个重要的函数是 flushAppendOnlyFile ，用于将 AOF 缓冲区的内容写入到 AOF 文件。</p>
<h3 id="12-开始主-loop"><a href="#12-开始主-loop" class="headerlink" title="12. 开始主 loop"></a>12. 开始主 loop</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">aeMain(server.el);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 事件处理器的主循环</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">aeMain</span><span class="params">(aeEventLoop *eventLoop)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    eventLoop-&gt;<span class="built_in">stop</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!eventLoop-&gt;<span class="built_in">stop</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果有需要在事件处理前执行的函数，那么运行它</span></span><br><span class="line">        <span class="keyword">if</span> (eventLoop-&gt;beforesleep != <span class="literal">NULL</span>)</span><br><span class="line">            eventLoop-&gt;beforesleep(eventLoop);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开始处理事件</span></span><br><span class="line">        aeProcessEvents(eventLoop, AE_ALL_EVENTS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>aeProcessEvents 方法之前看过，典型的 reactor 模式</p>
<h3 id="13-结束，清理-loop"><a href="#13-结束，清理-loop" class="headerlink" title="13. 结束，清理 loop"></a>13. 结束，清理 loop</h3><p>aeMain 是一个 while 循环，如果能执行到这里说明结束了，回收一下空间就行了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">aeDeleteEventLoop</span><span class="params">(aeEventLoop *eventLoop)</span> </span>&#123;</span><br><span class="line">    aeApiFree(eventLoop);</span><br><span class="line">    zfree(eventLoop-&gt;events);</span><br><span class="line">    zfree(eventLoop-&gt;fired);</span><br><span class="line">    zfree(eventLoop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="关于几个文件事件处理器的逻辑关系"><a href="#关于几个文件事件处理器的逻辑关系" class="headerlink" title="关于几个文件事件处理器的逻辑关系"></a>关于几个文件事件处理器的逻辑关系</h2><p>一共有 3 个：</p>
<ol>
<li><p>networking.c/acceptTcpHandler 函数是Redis的连接应答处理器，这个处理器用于对连接服务器监听套接字的客户端进行应答</p>
</li>
<li><p>networking.c/readQueryFromClient 函数是Redis的命令请求处理器，这个处理器负责从套接字中读入客户端发送的命令请求内容，具体实现为unistd.h/read函数的包装</p>
</li>
<li><p>networking.c/sendReplyToClient 函数是Redis的命令回复处理器，这个处理器负责将服务器执行命令后得到的命令回复通过套接字返回给客户端，具体实现为unistd.h/write函数的包装</p>
</li>
</ol>
<p>它们的逻辑关系是这样的：</p>
<ul>
<li><p>在 redis.c/initServer 中，redis server 的 main 方法在开始 EventLoop 之前，会进行一系列初始化，其中就包括了 initServer 一步，这个函数中的其中一个环节是开启 TCP 监听端口，注册了 acceptTcpHandler 到文件事件</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为 TCP 连接关联连接应答（accept）处理器</span></span><br><span class="line"><span class="comment">// 用于接受并应答客户端的 connect() 调用</span></span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.ipfd_count; j++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (aeCreateFileEvent(server.el, server.ipfd[j], AE_READABLE,</span><br><span class="line">                          acceptTcpHandler, <span class="literal">NULL</span>) == AE_ERR) &#123;</span><br><span class="line">        redisPanic(</span><br><span class="line">                <span class="string">"Unrecoverable error creating server.ipfd file event."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>一旦客户端 connect ，就会进入 acceptTcpHandler 方法，这个方法里会 accept 客户端连接，如果成功会进入 acceptCommonHandler 方法</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="built_in">max</span>--) &#123;</span><br><span class="line">    <span class="comment">// accept 客户端连接</span></span><br><span class="line">    cfd = anetTcpAccept(server.neterr, fd, cip, <span class="keyword">sizeof</span>(cip), &amp;cport);</span><br><span class="line">    <span class="keyword">if</span> (cfd == ANET_ERR) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno != EWOULDBLOCK)</span><br><span class="line">            redisLog(REDIS_WARNING,</span><br><span class="line">                     <span class="string">"Accepting client connection: %s"</span>, server.neterr);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    redisLog(REDIS_VERBOSE, <span class="string">"Accepted %s:%d"</span>, cip, cport);</span><br><span class="line">    <span class="comment">// 为客户端创建客户端状态（redisClient）</span></span><br><span class="line">    acceptCommonHandler(cfd, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>acceptCommonHandler 中会创建 redisClient</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((c = createClient(fd)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    redisLog(REDIS_WARNING,</span><br><span class="line">             <span class="string">"Error registering fd event for the new client: %s (fd=%d)"</span>,</span><br><span class="line">             strerror(errno), fd);</span><br><span class="line">    <span class="built_in">close</span>(fd); <span class="comment">/* May be already closed, just ignore errors */</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在创建客户端的方法 createClient 中，会绑定读事件到事件 loop ，开始接收命令请求，并注册 readQueryFromClient 这一事件处理器</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="comment">// 非阻塞</span></span><br><span class="line">    anetNonBlock(<span class="literal">NULL</span>, fd);</span><br><span class="line">    <span class="comment">// 禁用 Nagle 算法</span></span><br><span class="line">    anetEnableTcpNoDelay(<span class="literal">NULL</span>, fd);</span><br><span class="line">    <span class="comment">// 设置 keep alive</span></span><br><span class="line">    <span class="keyword">if</span> (server.tcpkeepalive)</span><br><span class="line">        anetKeepAlive(<span class="literal">NULL</span>, fd, server.tcpkeepalive);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定读事件到事件 loop （开始接收命令请求）</span></span><br><span class="line">    <span class="keyword">if</span> (aeCreateFileEvent(server.el, fd, AE_READABLE, readQueryFromClient, c) == AE_ERR) &#123;</span><br><span class="line">        <span class="built_in">close</span>(fd);</span><br><span class="line">        zfree(c);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>一旦客户端的请求到达，就会进入 readQueryFromClient 这一事件处理器，这个处理器里会读 client 的查询 buffer</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readQueryFromClient</span><span class="params">(aeEventLoop *el, <span class="keyword">int</span> fd, <span class="keyword">void</span> *privdata, <span class="keyword">int</span> mask)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从查询缓存重读取内容，创建参数，并执行命令</span></span><br><span class="line">    <span class="comment">// 函数会执行到缓存中的所有内容都被处理完为止</span></span><br><span class="line">    processInputBuffer(c);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>这个 processInputBuffer 方法会对请求的信息进行解析，变成 command 形式，然后执行这个 command</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">processInputBuffer</span><span class="params">(redisClient *c)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (processCommand(c) == REDIS_OK)</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行完 command 以后，会有执行结果，这个结果最终会返回给客户端，但是要客户端变得 WRITABLE 才行，所以要先放到 redis client 的 buffer 里面，这个过程要进行一堆函数调用</p>
<p>  <code>processCommand -&gt; addReply -&gt; _addReplyToBuffer -&gt; memcpy(c-&gt;buf + c-&gt;bufpos, s, len);</code></p>
</li>
<li><p>在 addReply 的时候，会绑定写事件到事件 loop ，注册 sendReplyToClient 这一事件处理器，当 fd 变得可写时触发</p>
<p>  <code>addReply -&gt; prepareClientToWrite -&gt; aeCreateFileEvent</code></p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">prepareClientToWrite</span><span class="params">(redisClient *c)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一般情况，为客户端套接字安装写处理器到事件循环</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;bufpos == <span class="number">0</span> &amp;&amp; listLength(c-&gt;reply) == <span class="number">0</span> &amp;&amp; (c-&gt;replstate == REDIS_REPL_NONE ||</span><br><span class="line">     c-&gt;replstate == REDIS_REPL_ONLINE) &amp;&amp; aeCreateFileEvent(server.el, c-&gt;fd, AE_WRITABLE, sendReplyToClient, c) == AE_ERR)</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<hr>
<h2 id="redis-不能简单说是一个单进程单线程-reactor"><a href="#redis-不能简单说是一个单进程单线程-reactor" class="headerlink" title="redis 不能简单说是一个单进程单线程 reactor"></a>redis 不能简单说是一个单进程单线程 reactor</h2><p>原因：</p>
<ul>
<li><p>执行 BGSAVE 、 BGREWRITEAOF 等命令时，会 fork 子进程</p>
</li>
<li><p>bio 会开两个后台线程，用于 aof 的 fsync 强制刷磁盘 和 文件的 close</p>
</li>
</ul>
<hr>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/Redis/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/Redis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB11_%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8_redisServer/" data-id="ck7naw863005g2cve1wqz0vss" class="article-share-link">分享到</a>
      

      
        <a href="http://yoursite.com/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/Redis/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/Redis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB11_%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8_redisServer/#ds-thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/Redis/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/Redis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB10_%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8_networking/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">Redis 源码阅读10_客户端和服务器_networking</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <div id="ds-thread" class="ds-thread" data-thread-key="开源组件/Redis/源码阅读/Redis源码阅读11_客户端和服务器_redisServer/" data-title="Redis 源码阅读11_客户端和服务器_redisServer" data-url="http://yoursite.com/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/Redis/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/Redis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB11_%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8_redisServer/"></div>
  </section>
</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/">开源组件</a><span class="category-list-count">23</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/Redis/">Redis</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/Redis/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">源码阅读</a><span class="category-list-count">11</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/muduo/">muduo</a><span class="category-list-count">12</span></li></ul></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Boost/" rel="tag">Boost</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CMake/" rel="tag">CMake</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cpp/" rel="tag">Cpp</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO/" rel="tag">IO</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Net/" rel="tag">Net</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Reactor/" rel="tag">Reactor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP/" rel="tag">TCP</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a><span class="tag-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Boost/" style="font-size: 12.5px;">Boost</a> <a href="/tags/C/" style="font-size: 17.5px;">C</a> <a href="/tags/CMake/" style="font-size: 10px;">CMake</a> <a href="/tags/Cpp/" style="font-size: 20px;">Cpp</a> <a href="/tags/IO/" style="font-size: 12.5px;">IO</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Net/" style="font-size: 15px;">Net</a> <a href="/tags/Reactor/" style="font-size: 10px;">Reactor</a> <a href="/tags/Redis/" style="font-size: 17.5px;">Redis</a> <a href="/tags/TCP/" style="font-size: 12.5px;">TCP</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 15px;">数据结构</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">23</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/Redis/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/Redis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB11_%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8_redisServer/">Redis 源码阅读11_客户端和服务器_redisServer</a>
          </li>
        
          <li>
            <a href="/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/Redis/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/Redis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB10_%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8_networking/">Redis 源码阅读10_客户端和服务器_networking</a>
          </li>
        
          <li>
            <a href="/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/Redis/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/Redis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB9_%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8_ae/">Redis 源码阅读9_客户端和服务器_ae</a>
          </li>
        
          <li>
            <a href="/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/Redis/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/Redis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB8_%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E7%8E%B0%E7%9B%B8%E5%85%B3_rdb/">Redis 源码阅读8_数据库实现相关_rdb</a>
          </li>
        
          <li>
            <a href="/%E5%BC%80%E6%BA%90%E7%BB%84%E4%BB%B6/Redis/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/Redis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB7_%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E7%8E%B0%E7%9B%B8%E5%85%B3_db/">Redis 源码阅读7_数据库实现相关_db</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="https://github.com/midudu" target="_blank">GitHub</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Midudu<br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="返回顶部"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<!-- 多说公共js代码 start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"midudu"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共js代码 end -->


<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>




<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
                processEscapes: true
                    
}
  
        });
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
tex2jax: {
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
                  
}
    
        });
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Queue(function() {
            var all = MathJax.Hub.getAllJax(), i;
            for(i=0; i < all.length; i += 1) {
                            all[i].SourceElement().parentNode.className += ' has-jax';
                                    
            }
                
        });
</script>

<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



<script src="/js/script.js"></script>


</div>
</body>
</html>
